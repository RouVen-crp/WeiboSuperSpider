### 无 GUI 功能独立版 ― 微博“转发信息”抓取代码总结

以下聚焦“转发相关信息”的采集与解析：包括“转发给谁”（原始用户/转发目标）与“转发次数”（转发数/转发计数）。按文件归纳，并附关键代码引用。

## WeiboUserScrapy.py（用户时间线抓取）

- 入口与分流（根据是否原创选择不同解析）：

```239:247:无 GUI 功能独立版/WeiboUserScrapy.py
    def get_weibo_content(self, info, is_original):
        """获取微博内容"""
        try:
            weibo_id = info.xpath('@id')[0][2:]
            if is_original:
                weibo_content = self.get_original_weibo(info, weibo_id)
            else:
                weibo_content = self.get_retweet(info, weibo_id)
            print(weibo_content)
            return weibo_content
        except Exception as e:
            print('Error: ', e)
            traceback.print_exc()
```

- 解析“转发给谁 + 转发文本”的核心逻辑：

```203:226:无 GUI 功能独立版/WeiboUserScrapy.py
    def get_retweet(self, info, weibo_id):
        """获取转发微博"""
        try:
            original_user = info.xpath("div/span[@class='cmt']/a/text()")
            if not original_user:
                wb_content = '转发微博已被删除'
                return wb_content
            else:
                original_user = original_user[0]
            wb_content = self.deal_garbled(info)
            wb_content = wb_content[wb_content.find(':') +
                                    1:wb_content.rfind('赞')]
            wb_content = wb_content[:wb_content.rfind('赞')]
            a_text = info.xpath('div//a/text()')
            if '全文' in a_text:
                weibo_link = 'https://weibo.cn/comment/' + weibo_id
                weibo_content = self.get_long_retweet(weibo_link)
                if weibo_content:
                    wb_content = weibo_content
            retweet_reason = self.deal_garbled(info.xpath('div')[-1])
            retweet_reason = retweet_reason[:retweet_reason.rindex('赞')]
            wb_content = (retweet_reason + '\n' + '原始用户: ' + original_user +
                          '\n' + '转发内容: ' + wb_content)
            return wb_content
        except Exception as e:
            print('Error: ', e)
            traceback.print_exc()
```

- 解析“转发次数”等底部统计：

```325:346:无 GUI 功能独立版/WeiboUserScrapy.py
    def get_weibo_footer(self, info):
        """获取微博点赞数、转发数、评论数"""
        try:
            footer = {}
            pattern = r'\d+'
            str_footer = info.xpath('div')[-1]
            str_footer = self.deal_garbled(str_footer)
            str_footer = str_footer[str_footer.rfind('赞'):]
            weibo_footer = re.findall(pattern, str_footer, re.M)

            up_num = int(weibo_footer[0])
            print('点赞数: ' + str(up_num))
            footer['up_num'] = up_num

            retweet_num = int(weibo_footer[1])
            print('转发数: ' + str(retweet_num))
            footer['retweet_num'] = retweet_num

            comment_num = int(weibo_footer[2])
            print('评论数: ' + str(comment_num))
            footer['comment_num'] = comment_num
            return footer
        except Exception as e:
            print('Error: ', e)
            traceback.print_exc()
```

- 汇总到结构体写出（含转发图与是否原创标记、转发数）：

```398:421:无 GUI 功能独立版/WeiboUserScrapy.py
    def get_one_weibo(self, info):
        """获取一条微博的全部信息"""
        try:
            weibo = OrderedDict()
            is_original = self.is_original(info)
            if (not self.filter) or is_original:
                weibo['id'] = info.xpath('@id')[0][2:]
                weibo['link'] = 'https://weibo.cn/comment/{}?uid={}&rl=0#cmtfrm'.format(weibo['id'], self.user_id)
                weibo['content'] = self.get_weibo_content(info,
                                                          is_original)  # 微博内容
                picture_urls = self.get_picture_urls(info, is_original)
                weibo['original_pictures'] = picture_urls[
                    'original_pictures']  # 原创图片url
                if not self.filter:
                    weibo['retweet_pictures'] = picture_urls[
                        'retweet_pictures']  # 转发图片url
                    weibo['original'] = is_original  # 是否原创微博
                weibo['publish_place'] = self.get_publish_place(info)  # 微博发布位置
                weibo['publish_time'] = self.get_publish_time(info)  # 微博发布时间
                weibo['publish_tool'] = self.get_publish_tool(info)  # 微博发布工具
                footer = self.get_weibo_footer(info)
                weibo['up_num'] = footer['up_num']  # 微博点赞数
                weibo['retweet_num'] = footer['retweet_num']  # 转发数
                weibo['comment_num'] = footer['comment_num']  # 评论数
            else:
                weibo = None
            return weibo
        except Exception as e:
            print('Error: ', e)
            traceback.print_exc()
```

要点：

- “转发给谁”来自 `div/span[@class='cmt']/a/text()`（即原始用户昵称）。
- “转发次数”在 `get_weibo_footer` 中以正则抽取（第二个数字即转发数）。

## WeiboTopicScrapy.py（关键词/时间段检索）

- 解析“转发微博”详情：

```133:156:无 GUI 功能独立版/WeiboTopicScrapy.py
    def get_retweet(self, info, weibo_id):
        """获取转发微博"""
        try:
            original_user = info.xpath("div/span[@class='cmt']/a/text()")
            if not original_user:
                wb_content = '转发微博已被删除'
                return wb_content
            else:
                original_user = original_user[0]
            wb_content = self.deal_garbled(info)
            wb_content = wb_content[wb_content.find(':') +
                                    1:wb_content.rfind('赞')]
            wb_content = wb_content[:wb_content.rfind('赞')]
            a_text = info.xpath('div//a/text()')
            if '全文' in a_text:
                weibo_link = 'https://weibo.cn/comment/' + weibo_id
                weibo_content = self.get_long_retweet(weibo_link)
                if weibo_content:
                    wb_content = weibo_content
            retweet_reason = self.deal_garbled(info.xpath('div')[-1])
            retweet_reason = retweet_reason[:retweet_reason.rindex('赞')]
            wb_content = (retweet_reason + '\n' + '原始用户: ' + original_user +
                          '\n' + '转发内容: ' + wb_content)
            return wb_content
        except Exception as e:
            print('Error: ', e)
            traceback.print_exc()
```

- 解析“转发次数”等底部统计：

```247:268:无 GUI 功能独立版/WeiboTopicScrapy.py
    def get_weibo_footer(self, info):
        """获取微博点赞数、转发数、评论数"""
        try:
            footer = {}
            pattern = r'\d+'
            str_footer = info.xpath('div')[-1]
            str_footer = self.deal_garbled(str_footer)
            str_footer = str_footer[str_footer.rfind('赞'):]
            weibo_footer = re.findall(pattern, str_footer, re.M)

            up_num = int(weibo_footer[0])
            print('点赞数: ' + str(up_num))
            footer['up_num'] = up_num

            retweet_num = int(weibo_footer[1])
            print('转发数: ' + str(retweet_num))
            footer['retweet_num'] = retweet_num

            comment_num = int(weibo_footer[2])
            print('评论数: ' + str(comment_num))
            footer['comment_num'] = comment_num
            return footer
        except Exception as e:
            print('Error: ', e)
            traceback.print_exc()
```

要点：

- 与 `WeiboUserScrapy.py` 相同思路：抽取原始用户、拼接转发文案、底部用正则抽取数字序列中的第 2 个值为“转发数”。

## WeiboCnTopicSpiderWithoutCookie.py（移动端搜索 API）

- 直接从接口字段读取“转发次数”（`reposts_count`），并映射为 `forward_count`：

```106:117:无 GUI 功能独立版/WeiboCnTopicSpiderWithoutCookie.py
            if item.get('isLongText') is False:  # 不是长文本
                data = {
                    'wid': item.get('id'),
                    'user_name': item.get('user').get('screen_name'),
                    'user_id': item.get('user').get('id'),
                    'gender': item.get('user').get('gender'),
                    'publish_time': time_formater(item.get('created_at')),
                    'text': pq(item.get("text")).text(),  # 仅提取内容中的文本
                    'like_count': item.get('attitudes_count'),  # 点赞数
                    'comment_count': item.get('comments_count'),  # 评论数
                    'forward_count': item.get('reposts_count'),  # 转发数
                }
```

要点：

- 此脚本不做“转发给谁”的 HTML 解析，仅消费 API 返回的 `reposts_count` 作为转发次数。

## WeiboComPostSpider.py（长文/文章抓取）

- 同样直接读取接口返回字段中的 `reposts_count`：

```165:188:无 GUI 功能独立版/WeiboComPostSpider.py
                created_at = post['created_at']

                reads_count = post['reads_count']

                reposts_count = post['reposts_count']

                comments_count = post['comments_count']

                attitudes_count = post['attitudes_count']

                print(detail_url)

                post_detail = self.parseDetail(detail_url)

                self.got_post.append({
                    'mid': mid,
                    'title': title,
                    'url': url,
                    'created_at': created_at,
                    'reads_count': reads_count,
                    'reposts_count': reposts_count,
                    'comments_count': comments_count,
                    'attitudes_count': attitudes_count,
                    'detail': post_detail
                })
```

要点：

- 该脚本聚焦图文长文，转发次数取自接口字段；不解析“转发给谁”。

### 小结

- “转发给谁（原始用户）”由基于 weibo.cn 的页面解析完成（`WeiboUserScrapy.py`、`WeiboTopicScrapy.py` 中的 `get_retweet`）。
- “转发次数”有两种来源：
  - 页面解析正则提取（`get_weibo_footer` 第 2 个数字）。
  - 直接消费接口字段 `reposts_count`（移动端/文章接口脚本）。
